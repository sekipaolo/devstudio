worker_processes  auto;

error_log  /usr/local/openresty/nginx/logs/error.log warn;
pid        /usr/local/openresty/nginx/logs/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       /usr/local/openresty/nginx/conf/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /usr/local/openresty/nginx/logs/access.log  main;

    sendfile        on;
    keepalive_timeout  65;

    server {
        listen       8080;
        server_name  localhost;

        client_max_body_size 20G;

        location / {
            root   /usr/local/openresty/nginx/html;
            index  index.html;
            auth_basic "Restricted Content";
            auth_basic_user_file /etc/nginx/.htpasswd;
            
            autoindex on;
        }

        location /upload {
            auth_basic "Restricted Content";
            auth_basic_user_file /etc/nginx/.htpasswd;
            
            client_body_temp_path /tmp;
            client_body_in_file_only on;
            client_body_buffer_size 128K;
            client_max_body_size 20G;

            content_by_lua_block {
                if ngx.req.get_method() == "POST" then
                    local upload_dir = "/usr/local/openresty/nginx/html/uploads"
                    ngx.req.read_body()
                    local file = ngx.req.get_body_file()
                    if file then
                        local filename = ngx.req.get_headers()["Content-Disposition"]
                        if filename then
                            filename = filename:match('filename="(.-)"')
                        else
                            filename = "uploaded_file_" .. os.time()
                        end
                        local dest_path = upload_dir .. "/" .. filename
                        os.execute("mv " .. file .. " " .. dest_path)
                        ngx.say("File uploaded successfully: " .. filename)
                    else
                        ngx.say("Upload failed: No file received")
                    end
                else
                    ngx.say("Method not allowed")
                end
            }
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   /usr/local/openresty/nginx/html;
        }
    }
}